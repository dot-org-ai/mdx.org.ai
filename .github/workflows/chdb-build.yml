name: Build @mdxdb/chdb

on:
  push:
    branches: [main]
    paths:
      - 'packages/@mdxdb/chdb/**'
  pull_request:
    paths:
      - 'packages/@mdxdb/chdb/**'
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip build cache'
        required: false
        default: 'false'

env:
  # Use ai-primitives forks with vector support enabled
  CHDB_REPO: https://github.com/ai-primitives/chdb.git
  CHDB_NODE_REPO: https://github.com/ai-primitives/chdb-node.git
  CHDB_BRANCH: main

jobs:
  build-linux-x64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          # Remove large unused packages to free disk space for ClickHouse build
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force || true
          df -h

      - name: Cache chdb build
        if: inputs.skip_cache != 'true'
        uses: actions/cache@v4
        with:
          path: /tmp/chdb
          key: chdb-linux-x64-${{ hashFiles('packages/@mdxdb/chdb/patches/*') }}

      - name: Set up build environment
        run: |
          # Add LLVM 19 repository (required by chdb)
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            clang-19 \
            lld-19 \
            llvm-19 \
            python3 \
            python3-pip \
            python3-setuptools \
            ccache \
            git
          pip3 install setuptools
          # Verify ccache is installed and in PATH
          which ccache && ccache --version
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 100
          sudo update-alternatives --install /usr/bin/lld lld /usr/bin/lld-19 100
          # Install Rust with required nightly toolchain for ClickHouse
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source "$HOME/.cargo/env"
          rustup install nightly-2025-07-07
          rustup default nightly-2025-07-07

      - name: Clone chdb (with vector support)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          if [ ! -d /tmp/chdb ]; then
            git clone -b $CHDB_BRANCH --depth 1 $CHDB_REPO /tmp/chdb
            cd /tmp/chdb
            git fetch --tags --depth 1
            # Use shallow submodule clone to save disk space
            git submodule update --init --recursive --depth 1
          fi

      - name: Build chdb core
        run: |
          cd /tmp/chdb
          source "$HOME/.cargo/env"
          export CC=clang-19
          export CXX=clang++-19
          # Configure ccache for clang
          ccache --set-config=cache_dir=/tmp/ccache
          ccache --set-config=max_size=5G
          export CCACHE_DIR=/tmp/ccache
          export PATH="/usr/lib/ccache:$PATH"
          # Create ccache symlinks if needed
          sudo ln -sf /usr/bin/ccache /usr/local/bin/ccache || true
          make buildlib
        timeout-minutes: 90

      - name: Clone chdb-node
        run: |
          git clone --depth 1 $CHDB_NODE_REPO /tmp/chdb-node

      - name: Build Node.js bindings
        run: |
          cd /tmp/chdb-node
          cp /tmp/chdb/buildlib/libchdb.so .
          npm install
          npm run build

      - name: Test build
        run: |
          cd /tmp/chdb-node
          node -e "
            const chdb = require('./build/Release/chdb.node');
            const session = new chdb.Session();

            // Test basic query
            console.log('Testing basic query...');
            const version = session.query('SELECT version()', 'JSON');
            console.log('Version:', version);

            // Test ULID
            console.log('Testing generateULID...');
            try {
              const ulid = session.query('SELECT generateULID() as ulid', 'JSON');
              console.log('ULID:', ulid);
            } catch(e) {
              console.log('ULID not available:', e.message);
            }

            // Test vector similarity
            console.log('Testing vector_similarity...');
            try {
              session.query('SET allow_experimental_vector_similarity_index = 1');
              session.query(\`
                CREATE TABLE test_vec (
                  id UInt64,
                  vec Array(Float32),
                  INDEX idx vec TYPE vector_similarity('hnsw', 'cosineDistance', 3) GRANULARITY 1
                ) ENGINE = MergeTree() ORDER BY id
              \`);
              console.log('Vector similarity: SUPPORTED');
              session.query('DROP TABLE test_vec');
            } catch(e) {
              console.log('Vector similarity not available:', e.message);
            }

            session.cleanup();
          "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: |
            /tmp/chdb-node/build/Release/chdb.node
            /tmp/chdb/buildlib/libchdb.so

  build-macos-arm64:
    runs-on: macos-14  # Apple Silicon
    env:
      # Set PATH for all steps in this job (GNU tools needed by cmake)
      PATH: /opt/homebrew/opt/llvm@19/bin:/opt/homebrew/opt/grep/libexec/gnubin:/opt/homebrew/opt/findutils/libexec/gnubin:/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
    steps:
      - uses: actions/checkout@v4

      - name: Cache chdb build
        if: inputs.skip_cache != 'true'
        uses: actions/cache@v4
        with:
          path: /tmp/chdb
          key: chdb-darwin-arm64-${{ hashFiles('packages/@mdxdb/chdb/patches/*') }}

      - name: Install dependencies
        run: |
          brew install cmake ninja llvm@19 findutils grep python-setuptools ccache
          # Verify GNU find and ccache are available
          gfind --version || find --version
          which ccache && ccache --version
          # Install setuptools for Python
          python3 -m pip install --break-system-packages setuptools || pip3 install setuptools || true
          # Symlink llvm@19 for chdb build script
          brew link llvm@19 --force || true
          # Install Rust with required nightly toolchain for ClickHouse
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source "$HOME/.cargo/env"
          rustup install nightly-2025-07-07
          rustup default nightly-2025-07-07

      - name: Clone chdb (with vector support)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          if [ ! -d /tmp/chdb ]; then
            git clone -b $CHDB_BRANCH --depth 1 $CHDB_REPO /tmp/chdb
            cd /tmp/chdb
            git fetch --tags --depth 1
            # Use shallow submodule clone to save disk space
            git submodule update --init --recursive --depth 1
          fi

      - name: Build chdb core
        run: |
          cd /tmp/chdb
          source "$HOME/.cargo/env"
          export CC=/opt/homebrew/opt/llvm@19/bin/clang
          export CXX=/opt/homebrew/opt/llvm@19/bin/clang++
          make buildlib
        timeout-minutes: 120

      - name: Build Node.js bindings
        run: |
          git clone --depth 1 $CHDB_NODE_REPO /tmp/chdb-node
          cd /tmp/chdb-node
          cp /tmp/chdb/buildlib/libchdb.dylib .
          npm install
          npm run build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: darwin-arm64
          path: |
            /tmp/chdb-node/build/Release/chdb.node
            /tmp/chdb/buildlib/libchdb.dylib

  build-macos-x64:
    runs-on: macos-13  # Intel
    env:
      # Set PATH for all steps in this job (GNU tools needed by cmake)
      PATH: /usr/local/opt/llvm@19/bin:/usr/local/opt/grep/libexec/gnubin:/usr/local/opt/findutils/libexec/gnubin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
    steps:
      - uses: actions/checkout@v4

      - name: Cache chdb build
        if: inputs.skip_cache != 'true'
        uses: actions/cache@v4
        with:
          path: /tmp/chdb
          key: chdb-darwin-x64-${{ hashFiles('packages/@mdxdb/chdb/patches/*') }}

      - name: Install dependencies
        run: |
          brew install cmake ninja llvm@19 findutils grep python-setuptools ccache
          # Verify GNU find and ccache are available
          gfind --version || find --version
          which ccache && ccache --version
          # Install setuptools for Python
          python3 -m pip install --break-system-packages setuptools || pip3 install setuptools || true
          brew link llvm@19 --force || true
          # Install Rust with required nightly toolchain for ClickHouse
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source "$HOME/.cargo/env"
          rustup install nightly-2025-07-07
          rustup default nightly-2025-07-07

      - name: Clone chdb (with vector support)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          if [ ! -d /tmp/chdb ]; then
            git clone -b $CHDB_BRANCH --depth 1 $CHDB_REPO /tmp/chdb
            cd /tmp/chdb
            git fetch --tags --depth 1
            # Use shallow submodule clone to save disk space
            git submodule update --init --recursive --depth 1
          fi

      - name: Build chdb core
        run: |
          cd /tmp/chdb
          source "$HOME/.cargo/env"
          export CC=/usr/local/opt/llvm@19/bin/clang
          export CXX=/usr/local/opt/llvm@19/bin/clang++
          make buildlib
        timeout-minutes: 120

      - name: Build Node.js bindings
        run: |
          git clone --depth 1 $CHDB_NODE_REPO /tmp/chdb-node
          cd /tmp/chdb-node
          cp /tmp/chdb/buildlib/libchdb.dylib .
          npm install
          npm run build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: darwin-x64
          path: |
            /tmp/chdb-node/build/Release/chdb.node
            /tmp/chdb/buildlib/libchdb.dylib

  package:
    needs: [build-linux-x64, build-macos-arm64, build-macos-x64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download linux-x64
        uses: actions/download-artifact@v4
        with:
          name: linux-x64
          path: packages/@mdxdb/chdb/prebuilds/linux-x64

      - name: Download darwin-arm64
        uses: actions/download-artifact@v4
        with:
          name: darwin-arm64
          path: packages/@mdxdb/chdb/prebuilds/darwin-arm64

      - name: Download darwin-x64
        uses: actions/download-artifact@v4
        with:
          name: darwin-x64
          path: packages/@mdxdb/chdb/prebuilds/darwin-x64

      - name: List prebuilds
        run: |
          echo "=== Prebuilds structure ==="
          find packages/@mdxdb/chdb/prebuilds -type f

      - name: Install dependencies
        run: |
          cd packages/@mdxdb/chdb
          pnpm install

      - name: Build TypeScript
        run: |
          cd packages/@mdxdb/chdb
          pnpm build

      - name: Run tests
        run: |
          cd packages/@mdxdb/chdb
          pnpm test

      - name: Publish to npm
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          cd packages/@mdxdb/chdb
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
