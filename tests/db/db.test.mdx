---
$type: TestSuite
$id: https://mdx.org.ai/tests/db
title: Database Provider Tests
description: Provider-agnostic database tests that run across all targets and backends
---

# Database Provider Tests

Tests for the `ai-database` schema-first database with promise pipelining.

These tests run across all target/db combinations:
- node + memory, fs, sqlite, chdb, clickhouse
- workers + memory, sqlite-do, clickhouse

## Schema Definition

```ts
const schema = {
  Post: {
    title: 'string',
    content: 'markdown',
    author: 'Author.posts',
    tags: ['Tag.posts'],
  },
  Author: {
    name: 'string',
    email: 'string',
  },
  Tag: {
    name: 'string',
    slug: 'string',
  },
}

const db = DB(schema)
```

## CRUD Operations

```ts test name="create and get entity"
import { DB } from 'ai-database'

const db = DB({
  Post: { title: 'string', content: 'string' },
})

const suffix = Date.now()
const id = `hello-world-${suffix}`
const post = await db.Post.create(id, {
  title: 'Hello World',
  content: 'This is my first post',
})

expect(post.$id).toBe(id)
expect(post.$type).toBe('Post')
expect(post.title).toBe('Hello World')

const fetched = await db.Post.get(id)
expect(fetched).not.toBeNull()
expect(fetched.title).toBe('Hello World')
```

```ts test name="list entities"
import { DB } from 'ai-database'

const db = DB({
  Post: { title: 'string', published: 'boolean' },
})

const suffix = Date.now()
await db.Post.create(`post-1-${suffix}`, { title: 'First', published: true })
await db.Post.create(`post-2-${suffix}`, { title: 'Second', published: false })
await db.Post.create(`post-3-${suffix}`, { title: 'Third', published: true })

const all = await db.Post.list()
expect(all.length).toBeGreaterThanOrEqual(3)

const published = await db.Post.list({ where: { published: true } })
expect(published.length).toBeGreaterThanOrEqual(2)
```

```ts test name="update entity"
import { DB } from 'ai-database'

const db = DB({
  Post: { title: 'string', views: 'number' },
})

const suffix = Date.now()
const id = `my-post-${suffix}`
await db.Post.create(id, { title: 'Original', views: 0 })

const updated = await db.Post.update(id, { views: 100 })
expect(updated.views).toBe(100)
expect(updated.title).toBe('Original')
```

```ts test name="delete entity"
import { DB } from 'ai-database'

const db = DB({
  Post: { title: 'string' },
})

const suffix = Date.now()
const id = `to-delete-${suffix}`
await db.Post.create(id, { title: 'Delete Me' })

const deleted = await db.Post.delete(id)
expect(deleted).toBe(true)

const fetched = await db.Post.get(id)
expect(fetched).toBeNull()
```

```ts test name="upsert entity"
import { DB } from 'ai-database'

const db = DB({
  Post: { title: 'string', views: 'number' },
})

const suffix = Date.now()
const id = `my-post-upsert-${suffix}`

// Create via upsert
const created = await db.Post.upsert(id, { title: 'Created', views: 0 })
expect(created.title).toBe('Created')

// Update via upsert
const updated = await db.Post.upsert(id, { title: 'Updated', views: 10 })
expect(updated.title).toBe('Updated')
expect(updated.views).toBe(10)
```

## Relationships

```ts test name="one-to-many relationship" skip
import { DB } from 'ai-database'

// NOTE: This test is skipped because backref resolution (author.posts)
// requires provider support that may not be available in all environments.

const db = DB({
  Post: { title: 'string', author: 'Author.posts' },
  Author: { name: 'string' },
})

const suffix = `${Date.now()}_${Math.random().toString(36).slice(2)}`
await db.Author.create(`john-${suffix}`, { name: 'John Doe' })
await db.Post.create(`post-1-rel-${suffix}`, { title: 'First Post', author: `john-${suffix}` })
await db.Post.create(`post-2-rel-${suffix}`, { title: 'Second Post', author: `john-${suffix}` })

const author = await db.Author.get(`john-${suffix}`)
expect(author.name).toBe('John Doe')

// Backref should return posts
const posts = await author.posts
expect(posts.length).toBe(2)
```

```ts test name="many-to-many relationship" skip
import { DB } from 'ai-database'

// NOTE: This test is skipped because backref resolution (tag.posts)
// requires provider support that may not be available in all environments.

const db = DB({
  Post: { title: 'string', tags: ['Tag.posts'] },
  Tag: { name: 'string' },
})

const suffix = `${Date.now()}_${Math.random().toString(36).slice(2)}`
await db.Tag.create(`tech-${suffix}`, { name: 'Technology' })
await db.Tag.create(`ai-${suffix}`, { name: 'AI' })
await db.Post.create(`my-post-tags-${suffix}`, { title: 'AI in Tech', tags: [`tech-${suffix}`, `ai-${suffix}`] })

const post = await db.Post.get(`my-post-tags-${suffix}`)
const tags = await post.tags
expect(tags.length).toBe(2)

const techTag = await db.Tag.get(`tech-${suffix}`)
const techPosts = await techTag.posts
expect(techPosts.length).toBe(1)
```

## Search

```ts test name="search entities"
import { DB } from 'ai-database'

const db = DB({
  Post: { title: 'string', content: 'string' },
})

const suffix = Date.now()
await db.Post.create(`post-js-${suffix}`, { title: 'JavaScript Guide', content: 'Learn JS' })
await db.Post.create(`post-ts-${suffix}`, { title: 'TypeScript Tips', content: 'TS is great' })
await db.Post.create(`post-py-${suffix}`, { title: 'Python Basics', content: 'Learn Python' })

const jsResults = await db.Post.search('JavaScript')
expect(jsResults.length).toBeGreaterThanOrEqual(1)
const jsGuide = jsResults.find(r => r.title === 'JavaScript Guide')
expect(jsGuide).toBeDefined()
```

## Pagination

```ts test name="list with pagination"
import { DB } from 'ai-database'

const db = DB({
  Post: { title: 'string', order: 'number' },
})

const suffix = Date.now()
for (let i = 1; i <= 10; i++) {
  await db.Post.create(`post-page-${i}-${suffix}`, { title: `Post ${i}`, order: i })
}

const first5 = await db.Post.list({ limit: 5, orderBy: 'order', order: 'asc' })
expect(first5.length).toBe(5)
```

## Run with different providers

```bash
# Run with filesystem (Node only)
mdxe test --target node --db fs

# Run with SQLite (Node)
mdxe test --target node --db sqlite

# Run with ClickHouse local (Node only)
mdxe test --target node --db chdb

# Run with SQLite Durable Objects (Workers only)
mdxe test --target workers --db sqlite-do

# Run with remote ClickHouse (Workers)
mdxe test --target workers --db clickhouse

# Run full matrix
mdxe test --target all --db all
```
