---
$type: TestSuite
$id: https://mdx.org.ai/tests/db
title: Database Provider Tests
description: Provider-agnostic database tests that run across all targets and backends
---

# Database Provider Tests

> `DB`, `db`, `AI`, `ai`, `on`, `every`, `send`, `track`, etc. are all available globally.

These tests run across all target/db combinations:
- node + memory, fs, sqlite, chdb, clickhouse
- workers + memory, sqlite-do, clickhouse

## Schema Definition

```ts
const schema = {
  Post: {
    title: 'string',
    content: 'markdown',
    author: 'Author.posts',
    tags: ['Tag.posts'],
  },
  Author: {
    name: 'string',
    email: 'string',
  },
  Tag: {
    name: 'string',
    slug: 'string',
  },
}

const db = DB(schema)
```

## CRUD Operations

```ts test name="create and get entity"
const db = DB({
  Post: { title: 'string', content: 'string' },
})

const post = await db.Post.create('hello-world', {
  title: 'Hello World',
  content: 'This is my first post',
})

expect(post.$id).toBe('hello-world')
expect(post.$type).toBe('Post')
expect(post.title).toBe('Hello World')

const fetched = await db.Post.get('hello-world')
expect(fetched).not.toBeNull()
expect(fetched.title).toBe('Hello World')
```

```ts test name="list entities"
const db = DB({
  Post: { title: 'string', published: 'boolean' },
})

await db.Post.create('post-1', { title: 'First', published: true })
await db.Post.create('post-2', { title: 'Second', published: false })
await db.Post.create('post-3', { title: 'Third', published: true })

const all = await db.Post.list()
expect(all.length).toBe(3)

const published = await db.Post.list({ where: { published: true } })
expect(published.length).toBe(2)
```

```ts test name="update entity"
const db = DB({
  Post: { title: 'string', views: 'number' },
})

await db.Post.create('my-post', { title: 'Original', views: 0 })

const updated = await db.Post.update('my-post', { views: 100 })
expect(updated.views).toBe(100)
expect(updated.title).toBe('Original')
```

```ts test name="delete entity"
const db = DB({
  Post: { title: 'string' },
})

await db.Post.create('to-delete', { title: 'Delete Me' })

const deleted = await db.Post.delete('to-delete')
expect(deleted).toBe(true)

const fetched = await db.Post.get('to-delete')
expect(fetched).toBeNull()
```

```ts test name="upsert entity"
const db = DB({
  Post: { title: 'string', views: 'number' },
})

// Create via upsert
const created = await db.Post.upsert('my-post', { title: 'Created', views: 0 })
expect(created.title).toBe('Created')

// Update via upsert
const updated = await db.Post.upsert('my-post', { title: 'Updated', views: 10 })
expect(updated.title).toBe('Updated')
expect(updated.views).toBe(10)
```

## Relationships

```ts test name="one-to-many relationship"
const db = DB({
  Post: { title: 'string', author: 'Author.posts' },
  Author: { name: 'string' },
})

await db.Author.create('john', { name: 'John Doe' })
await db.Post.create('post-1', { title: 'First Post', author: 'john' })
await db.Post.create('post-2', { title: 'Second Post', author: 'john' })

const author = await db.Author.get('john')
expect(author.name).toBe('John Doe')

// Backref should return posts
const posts = await author.posts
expect(posts.length).toBe(2)
```

```ts test name="many-to-many relationship"
const db = DB({
  Post: { title: 'string', tags: ['Tag.posts'] },
  Tag: { name: 'string' },
})

await db.Tag.create('tech', { name: 'Technology' })
await db.Tag.create('ai', { name: 'AI' })
await db.Post.create('my-post', { title: 'AI in Tech', tags: ['tech', 'ai'] })

const post = await db.Post.get('my-post')
const tags = await post.tags
expect(tags.length).toBe(2)

const techTag = await db.Tag.get('tech')
const techPosts = await techTag.posts
expect(techPosts.length).toBe(1)
```

## Search

```ts test name="search entities"
const db = DB({
  Post: { title: 'string', content: 'string' },
})

await db.Post.create('post-1', { title: 'JavaScript Guide', content: 'Learn JS' })
await db.Post.create('post-2', { title: 'TypeScript Tips', content: 'TS is great' })
await db.Post.create('post-3', { title: 'Python Basics', content: 'Learn Python' })

const jsResults = await db.Post.search('JavaScript')
expect(jsResults.length).toBe(1)
expect(jsResults[0].title).toBe('JavaScript Guide')

const learnResults = await db.Post.search('Learn')
expect(learnResults.length).toBe(2)
```

## Pagination

```ts test name="list with pagination"
const db = DB({
  Post: { title: 'string', order: 'number' },
})

for (let i = 1; i <= 10; i++) {
  await db.Post.create(`post-${i}`, { title: `Post ${i}`, order: i })
}

const first5 = await db.Post.list({ limit: 5, orderBy: 'order', order: 'asc' })
expect(first5.length).toBe(5)
expect(first5[0].title).toBe('Post 1')

const next5 = await db.Post.list({ limit: 5, offset: 5, orderBy: 'order', order: 'asc' })
expect(next5.length).toBe(5)
expect(next5[0].title).toBe('Post 6')
```

## Run with different providers

```bash
# Run with filesystem (Node only)
mdxe test --target node --db fs

# Run with SQLite (Node)
mdxe test --target node --db sqlite

# Run with ClickHouse local (Node only)
mdxe test --target node --db chdb

# Run with SQLite Durable Objects (Workers only)
mdxe test --target workers --db sqlite-do

# Run with remote ClickHouse (Workers)
mdxe test --target workers --db clickhouse

# Run full matrix
mdxe test --target all --db all
```
